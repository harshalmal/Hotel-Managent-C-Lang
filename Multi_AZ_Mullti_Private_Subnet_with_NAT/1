## Terraform AWS Provider
terraform {
    required_providers {
    aws = {
        source = "hashicorp/aws"
        version = "5.8.0"
    }
    }
}

provider "aws" {
    region     = "ap-south-1" 
    access_key = "Put here AWS Account Access Key"
    secret_key = "Put here AWS Account Secret Key"
}

## Create VPC
resource "aws_vpc" "main_vpc" {
    cidr_block       = "10.20.0.0/20"  ## Total Host Count = 4094
    instance_tenancy = "default"

    tags = {
    Name = "main_vpc"
}
}

## Create Subnets (Public = 1, Private = 6)
resource "aws_subnet" "pub_sub" { 
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.0.0/22"
    availability_zone = "ap-south-1a"
    ##  map_public_ip_on_launch = true
    tags = {
    Name = "pub_sub"
    }
}

resource "aws_subnet" "priv_sub_1" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.4.0/23"
    availability_zone = "ap-south-1a"

    tags = {
    Name = "priv_sub_1"
    }
}

resource "aws_subnet" "priv_sub_2" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.6.0/23"
    availability_zone = "ap-south-1a"

    tags = {
    Name = "priv_sub_2"
    }
}

resource "aws_subnet" "priv_sub_3" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.8.0/23"
    availability_zone = "ap-south-1b"

    tags = {
    Name = "priv_sub_3"
    }
}

resource "aws_subnet" "priv_sub_4" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.10.0/23"
    availability_zone = "ap-south-1b"

    tags = {
    Name = "priv_sub_4"
    }
}

resource "aws_subnet" "priv_sub_5" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.12.0/23"
    availability_zone = "ap-south-1c"

    tags = {
    Name = "priv_sub_5"
    }
}

resource "aws_subnet" "priv_sub_6" {
    vpc_id     = aws_vpc.main_vpc.id
    cidr_block = "10.20.14.0/23"
    availability_zone = "ap-south-1c"

    tags = {
    Name = "priv_sub_6"
    }
}


## Internet Gateway

resource "aws_internet_gateway" "igw" {
    vpc_id = aws_vpc.main_vpc.id
    tags = {
    Name = "igw"
    }
}


## Create EIP

resource "aws_eip" "eip" {
    domain = "vpc"
    
    tags = {
    Name = "eip"
    }
}


## Create NAT GW

resource "aws_nat_gateway" "nat_gw" {
    allocation_id = aws_eip.eip.id
    subnet_id     = aws_subnet.pub_sub.id
    connectivity_type = "public"
    
    tags = {
    Name = "nat_gw"
}

depends_on = [aws_internet_gateway.igw]   
}


## Route Table

#  Public RT
resource "aws_route_table" "pub_rt" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.igw.id
    }

    tags = {
    Name = "pub_rt"
    }
    }

#  Private RT (Total 6 RT's)
resource "aws_route_table" "priv_rt_1" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_1"
    }
}

resource "aws_route_table" "priv_rt_2" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_2"
    }
}

resource "aws_route_table" "priv_rt_3" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_3"
    }
}

resource "aws_route_table" "priv_rt_4" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_4"
    }
}

resource "aws_route_table" "priv_rt_5" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_5"
    }
}

resource "aws_route_table" "priv_rt_6" {
    vpc_id = aws_vpc.main_vpc.id
    route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.nat_gw.id
    }
    tags = {
    Name = "priv_rt_6"
    }
}

## Route table Association

resource "aws_route_table_association" "pub_rt_asso" {
    subnet_id = aws_subnet.pub_sub.id
    route_table_id = aws_route_table.pub_rt.id
}

resource "aws_route_table_association" "priv_rt_asso_1" {
    subnet_id = aws_subnet.priv_sub_1.id
    route_table_id = aws_route_table.priv_rt_1.id
}

resource "aws_route_table_association" "priv_rt_asso_2" {
    subnet_id = aws_subnet.priv_sub_2.id
    route_table_id = aws_route_table.priv_rt_2.id
}

resource "aws_route_table_association" "priv_rt_asso_3" {
    subnet_id = aws_subnet.priv_sub_3.id
    route_table_id = aws_route_table.priv_rt_3.id
}

resource "aws_route_table_association" "priv_rt_asso_4" {
    subnet_id = aws_subnet.priv_sub_4.id
    route_table_id = aws_route_table.priv_rt_4.id
}

resource "aws_route_table_association" "priv_rt_asso_5" {
    subnet_id = aws_subnet.priv_sub_5.id
    route_table_id = aws_route_table.priv_rt_5.id
}

resource "aws_route_table_association" "priv_rt_asso_6" {
    subnet_id = aws_subnet.priv_sub_6.id
    route_table_id = aws_route_table.priv_rt_6.id
}


